from datetime import datetime
from dateutil.relativedelta import relativedelta
import requests
import shutil
import pandas as pd 
from logbook import Logger
import logbook
from zipfile import ZipFile
import time
import os

log = Logger('binance_data.py', level = logbook.INFO)

columns = ['Open_time', 'Open', 'High', 'Low', 'Close', 'Volume', 'Close_time', 'Quote_asset_volume', 'Number_of_trades', 'Taker_but_base_asset_volume', 'Taker_but_quote_asset_volume', 'Ignore']


def download_spot_klines(symbol, period, date: datetime, path):
    '''
    下載現貨歷史行情K棒
    :symbol: 交易對
    :period: 時間週期, 這邊是一天(日線K棒)
    :date: 日期
    :path: 檔案路徑
    '''



    url = 'https://data.binance.vision/data/spot/daily/klines/%s/%s/%s-%s-%s-%02d-%02d.zip' %(symbol, period, symbol, period, date.year, date.month, date.day)

    log.info(url)

    with requests.get(url, stream = True) as r:
        with open(path, 'wb') as f:
            shutil.copyfileobj(r.raw, f)

    return path


def download_spot_klines_range(symbol, period, start: datetime, end: datetime, dir = ''):
    '''
    下載指定時間範圍的幣安現貨K棒歷史價格數據
    :symbol: 交易對
    :period: 時間週期
    :start: 開始日期
    :end: 結束日期
    :dir: 存放地址    
    '''

    
    
    if len(dir) > 0 and not dir.edmswith('/'):
        dir += '/'

    os.makedirs('%s%s/%s' % (dir, symbol, period), exist_ok = True )

    while True:

        path = '%s%s/%s/%s-%s-%s-%02d-%02d.zip' % (dir, symbol, period, symbol, period, start.year, start.month, start.day)

        download_spot_klines(symbol, period, start, path)

        start = start + relativedelta(days=+1)

        if start > end:
            break

        time.sleep(2)


def read_history_file(zip_file, csv_file) -> pd.DataFrame:
    '''
    讀取歷史數據文件
    :zip_file: zip文件路徑
    :csv_file: csv文件路徑
    '''

    zf = ZipFile(zip_file)
    file = zf.open(csv_file)
    df = pd.read_csv(file, header = None, names = columns)
    file.close()
    zf.close()
    return df


def merge_history_file(dir, output) -> pd.DataFrame:
    '''
    :dir: 歷史數據文件存放目錄
    :output: 合併文件輸出路徑
    '''

    merge_df = None

    for file in os.listdir(dir):
        log.info('merge %s to %s' % (file, output))

        df = read_history_file(dir + '/' + file, file.replace('.zip', '.csv'))

        merge_df = df if merge_df is None else pd.concat([merge_df, df])

    merge_df.to_csv(output, index=False)

    return merge_df



if __name__ == '__main__':

    download_spot_klines_range('貨幣交易對', '1d', start=datetime(2021, 3, 1), end=datetime(2022, 7, 1))

    merge_history_file('C:/Users/User/Desktop/貨幣交易對/1d', 'C:/Users/User/Desktop/貨幣交易對/貨幣交易對-1d.csv')

